unique_name: query_log
object_type: dataset
label: query_log
columns:
  - name: user_email
    data_type: string
  - name: AtScaleUser
    data_type: string
  - name: creation_date
    data_type: datetime
  - name: job_id
    data_type: string
  - name: total_bytes_processed
    data_type: long
  - name: total_slot_ms
    data_type: long
  - name: week_id
    data_type: datetime
  - name: Week
    data_type: long
  - name: Month
    data_type: datetime
  - name: MonthName
    data_type: string
  - name: Year
    data_type: datetime
  - name: YearName
    data_type: long
connection_id: con_gbl-dat-atscale-dev_atscale_veolia_contextual_data
sql: |-
  SELECT
    INF.user_email,
    REGEXP_EXTRACT(INF.query, r"\/\*.username=(.*)\*\/") as AtScaleUser,
    timestamp(DATE_TRUNC(date(INF.creation_time), day)) as creation_date,
    timestamp(DATE_TRUNC(date(INF.creation_time), week)) as week_id,
    extract(week from INF.creation_time) as Week,
    timestamp(DATE_TRUNC(date( INF.creation_time), month)) as Month,
    FORMAT_DATETIME('%B', DATE_TRUNC(date( INF.creation_time), month)) as MonthName,
    timestamp(DATE_TRUNC(date( INF.creation_time), year)) as Year,
    extract(year from INF.creation_time) as YearName,
    INF.job_id,
    INF.total_bytes_processed,
    INF.total_slot_ms
    FROM
      `region-EU`.INFORMATION_SCHEMA.JOBS INF
    WHERE
    INF.user_email in('atscale-bqaccess@gbl-dat-atscale-dev.iam.gserviceaccount.com')
    ORDER BY creation_time  desc
